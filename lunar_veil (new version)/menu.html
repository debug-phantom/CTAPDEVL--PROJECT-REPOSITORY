<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lunar Veil Cafe ☕ — Menu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ------------------------------------- */
    /* I. Global & Header Styles */
    /* ------------------------------------- */
    :root{
      --color-dark: #0A0A1F;
      --color-primary: #8A2BE2; /* Amethyst */
      --color-secondary: #FFD700; /* Gold */
      --color-accent: #2c254b; /* Deep Purple Background Accent */
      --color-light: #E0E0E0; /* Off-White */
      --color-error: #FF6347; /* Tomato */
      --font-heading: 'Cinzel', serif;
      --font-body: 'Inter', sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;font-family:var(--font-body);background-color:var(--color-dark);color:var(--color-light);
      background-image: radial-gradient(var(--color-accent) 1px, transparent 0), radial-gradient(var(--color-accent) 1px, transparent 0);
      background-size:80px 80px;background-position:0 0,40px 40px;
    }
    header{
      background-color:var(--color-accent);color:var(--color-secondary);padding:15px 20px;
      display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0, 0, 0, 0.5);
    }
    header h1{
      font-family:var(--font-heading);font-size:1.8em;margin:0;
    }
    nav a{
      color:var(--color-light);text-decoration:none;padding:8px 15px;border-radius:5px;
      transition:background-color 0.3s;
    }
    nav a:hover{
      background-color:rgba(255, 255, 255, 0.1);
    }
    .container{
      width:90%;max-width:1200px;margin:20px auto;padding:20px;
    }
    .text-center{text-align:center;}
    
    /* Buttons */
    .btn{
      padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:background-color 0.3s;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn-primary{
      background-color:var(--color-primary);color:var(--color-light);
    }
    .btn-primary:hover{
      background-color:darken(var(--color-primary), 10%);
    }
    
    /* ------------------------------------- */
    /* II. Menu Grid Styles */
    /* ------------------------------------- */
    .menu-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;padding:20px 0;
    }
    .category-header{
      grid-column:1/-1;text-align:center;color:var(--color-secondary);font-family:var(--font-heading);
      margin-top:20px;font-size:1.8em;padding:10px 0;border-bottom:2px solid var(--color-secondary);
    }
    .menu-item{
      background-color:var(--color-accent);padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .item-header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;
    }
    .item-header h3{
      margin:0;font-size:1.3em;color:var(--color-secondary);
    }
    .item-header .price{
      font-weight:700;font-size:1.3em;color:var(--color-primary);
    }
    .menu-item p{
      font-size:0.9em;color:var(--color-light);margin-bottom:15px;flex-grow:1;
    }
    .menu-item button{
      width:100%;
    }

    /* ------------------------------------- */
    /* III. Slideshow Styles */
    /* ------------------------------------- */
    .slideshow-container {
        max-width: 800px;
        margin: 20px auto;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        overflow: hidden;
        background-color: var(--color-accent);
    }

    .slide {
        display: none; /* Hidden by default */
        padding: 40px 20px;
        text-align: center;
        min-height: 250px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .slide.active {
        display: block;
        animation: fadeIn 1.5s;
    }

    @keyframes fadeIn {
        from { opacity: 0.4; }
        to { opacity: 1; }
    }

    .slide h3 {
        color: var(--color-secondary);
        font-size: 2.2em;
        font-family: var(--font-heading);
        margin-bottom: 10px;
        margin-top: 10px;
    }

    .slide p {
        font-size: 1.1em;
        margin-bottom: 20px;
        max-width: 600px;
    }

    .slide-price {
        font-size: 1.8em;
        color: var(--color-light);
        font-weight: bold;
        margin-bottom: 20px;
    }

    .slideshow-nav {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        padding: 0 10px;
        pointer-events: none; /* Allows clicks to pass through if not on button */
    }

    .prev, .next {
        cursor: pointer;
        color: var(--color-light);
        font-weight: bold;
        font-size: 28px;
        transition: 0.6s ease;
        user-select: none;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 5px;
        pointer-events: all;
        z-index: 10;
        line-height: 1;
    }

    .prev:hover, .next:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .menu-grid{grid-template-columns:1fr;}
        .category-header{font-size:1.5em;}
        .slide h3 { font-size: 1.8em; }
        .slide-price { font-size: 1.4em; }
        .slide p { font-size: 1em; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Lunar Veil Cafe ☕</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="cart.html">Cart <span id="cart-count"></span></a>
    </nav>
  </header>

  <main class="container">
    <h2 class="text-center" style="font-family: var(--font-heading); color: var(--color-primary);">Our Menu</h2>
    
    <div id="featured-slideshow" class="slideshow-container">
        </div>

    <section id="menu-items" class="menu-grid">
        <p class="text-center" style="grid-column: 1/-1;">Loading menu...</p>
    </section>
  </main>

<script>
    // I. DATA & STATE MANAGEMENT
    let cart = JSON.parse(localStorage.getItem('cafeCart')) || [];
    let menuItems = []; // Store fetched menu items
    
    // Global state for slideshow
    let slideIndex = 1;
    let featuredItems = [];

    // II. UTILITIES

    /**
     * Checks login status and redirects if not logged in.
     */
    async function checkLoginStatus() {
        try {
            const response = await fetch('auth.php', {
                method: 'POST', body: JSON.stringify({ action: 'status' }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (!data.isLoggedIn) {
                window.location.href = 'login.html';
            } else {
                renderCartCount(); // Ensure cart count is updated on load
                // No need to load balance on this page, but keep the cart count
            }
        } catch (error) {
            console.error('Error checking login status:', error);
        }
    }
    
    /**
     * Maps a product category/name to a Lucide icon name.
     * @param {string} category - The product category.
     * @returns {string} The Lucide icon name.
     */
    function getIconForCategory(category) {
        const lowerCategory = category.toLowerCase();
        // Use 'coffee' for all general drinks
        if (lowerCategory.includes('espresso') || lowerCategory.includes('latte') || lowerCategory.includes('frappe') || lowerCategory.includes('tea')) {
            return 'coffee'; 
        } 
        // Use 'croissant' (bread icon) for all food items
        else if (lowerCategory.includes('pastry') || lowerCategory.includes('dessert')) {
            return 'croissant'; 
        }
        return 'star'; // Default icon for other specials
    }
    
    // III. SLIDESHOW LOGIC
    
    /**
     * Renders the featured item slideshow.
     * Items categorized as 'Special' in the database are used as featured items.
     */
    function renderFeaturedSlideshow(allProducts) {
        const slideshowContainer = document.getElementById('featured-slideshow');
        // Filter items where the category is 'Special'
        featuredItems = allProducts.filter(item => item.category === 'Special');

        if (featuredItems.length === 0) {
            slideshowContainer.style.display = 'none';
            return;
        }

        let slidesHTML = '';
        featuredItems.forEach((item, index) => {
            const icon = getIconForCategory(item.category);
            slidesHTML += `
                <div class="slide fade" data-index="${index + 1}">
                    <i data-lucide="${icon}" style="width: 48px; height: 48px; color: var(--color-secondary);"></i>
                    <h3>${item.name} (Featured Special!)</h3>
                    <p>${item.description}</p>
                    <p class="slide-price">Only $${item.price}</p>
                    <button class="btn btn-primary add-to-cart-btn" 
                        data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
                        <i data-lucide="shopping-cart" style="width: 18px; height: 18px;"></i> Add to Cart
                    </button>
                </div>
            `;
        });

        const navHTML = featuredItems.length > 1 ? `
            <div class="slideshow-nav">
                <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                <a class="next" onclick="plusSlides(1)">&#10095;</a>
            </div>
        ` : ''; // Only show nav if more than one slide

        slideshowContainer.innerHTML = slidesHTML + navHTML;
        showSlides(slideIndex);
        addCartListeners(); // Re-attach listeners to the new buttons
        lucide.createIcons(); // Render lucide icons
    }
    
    /**
     * Changes the current slide by a given offset.
     * @param {number} n - The number of slides to move (1 for next, -1 for previous).
     */
    window.plusSlides = function(n) {
        showSlides(slideIndex += n);
    }

    /**
     * Displays a specific slide and handles wrap-around logic.
     * @param {number} n - The index of the slide to display (1-based).
     */
    function showSlides(n) {
        const slides = document.getElementsByClassName("slide");
        if (slides.length === 0) return;

        // Wrap around logic
        if (n > slides.length) { slideIndex = 1 }    
        if (n < 1) { slideIndex = slides.length }

        // Hide all slides
        for (let i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";  
        }
        
        // Show the current slide
        slides[slideIndex-1].style.display = "flex"; // Changed to flex for centering
    }

    // IV. MAIN MENU RENDERING

    async function fetchMenu() {
        try {
            const response = await fetch('get_menu.php');
            const data = await response.json();

            if (data.success) {
                menuItems = data.menu;
                
                // 1. Render the slideshow first (using 'Special' items)
                renderFeaturedSlideshow(menuItems); 

                // 2. Render the main menu
                renderMenu(menuItems);

            } else {
                document.getElementById('menu-items').innerHTML = '<p class="text-center" style="grid-column: 1/-1;">Error loading menu.</p>';
                console.error('Menu load failed:', data.message);
            }
        } catch (error) {
            document.getElementById('menu-items').innerHTML = '<p class="text-center" style="grid-column: 1/-1;">Connection error. Could not load menu.</p>';
            console.error('Fetch error:', error);
        }
    }

    function renderMenu(products) {
        const menuContainer = document.getElementById('menu-items');
        menuContainer.innerHTML = '';
        
        let currentCategory = '';
        
        products.forEach(item => {
            if (item.category !== currentCategory) {
                currentCategory = item.category;
                menuContainer.innerHTML += `<h2 class="category-header">${currentCategory}</h2>`;
            }

            // Skip 'Special' items from the main grid since they are in the slideshow
            if (item.category === 'Special') {
                return; 
            }

            menuContainer.innerHTML += `
                <div class="menu-item">
                    <div class="item-header">
                        <h3>${item.name}</h3>
                        <span class="price">$${item.price}</span>
                    </div>
                    <p>${item.description}</p>
                    <button class="btn btn-primary add-to-cart-btn" 
                        data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
                        <i data-lucide="shopping-cart" style="width: 18px; height: 18px;"></i> Add to Cart
                    </button>
                </div>
            `;
        });
        
        addCartListeners(); // Add listeners to all new menu buttons
        lucide.createIcons(); // Re-render lucide icons in the main menu
    }
    
    // V. CART LOGIC

    function addCartListeners() {
        // Remove existing listeners before re-attaching to prevent duplicates
        // A full re-render approach often simplifies this, but for robustness:
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            // Clone and replace to efficiently remove all existing listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });

        // Add listeners to all buttons (including new slideshow buttons)
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                const name = e.currentTarget.getAttribute('data-name');
                const price = parseFloat(e.currentTarget.getAttribute('data-price'));
                
                addToCart({ id, name, price });
            });
        });
    }

    function addToCart(product) {
        const existingItem = cart.find(item => item.id === product.id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ id: product.id, name: product.name, price: product.price, quantity: 1 });
        }

        localStorage.setItem('cafeCart', JSON.stringify(cart));
        renderCartCount();
        alert(`Added ${product.name} to cart!`);
    }
    
    function renderCartCount() {
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        const cartCountSpan = document.getElementById('cart-count');
        if (totalItems > 0) {
            cartCountSpan.textContent = `(${totalItems})`;
            cartCountSpan.style.marginLeft = '5px';
        } else {
            cartCountSpan.textContent = '';
            cartCountSpan.style.marginLeft = '0';
        }
    }

    // VI. INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
        checkLoginStatus(); 
        fetchMenu(); // Now handles both slideshow and main menu rendering
    });
</script>

</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lunar Veil Cafe ☕ — Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ------------------------------------- */
    /* I. Global & Header Styles (Consistent) */
    /* ------------------------------------- */
    :root{
      --color-dark: #0A0A1F;
      --color-primary: #8A2BE2; /* Amethyst */
      --color-secondary: #FFD700; /* Gold */
      --color-accent: #2c254b; /* Deep Purple Background Accent */
      --color-light: #E0E0E0; /* Off-White */
      --color-error: #FF6347; /* Tomato */
      --color-success: #32CD32; /* Green for success */
      --font-heading: 'Cinzel', serif;
      --font-body: 'Inter', sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;font-family:var(--font-body);background-color:var(--color-dark);color:var(--color-light);
      background-image: radial-gradient(var(--color-accent) 1px, transparent 0), radial-gradient(var(--color-accent) 1px, transparent 0);
      background-size:80px 80px;background-position:0 0,40px 40px;
    }
    a{color:var(--color-secondary);text-decoration:none}
    a:hover{text-decoration:underline}
    .header{
        background-color: var(--color-accent);
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    .nav a {
        color: var(--color-light);
        margin-left: 20px;
        font-weight: 600;
        transition: color 0.3s;
    }
    .nav a:hover {
        color: var(--color-secondary);
        text-decoration: none;
    }
    .logo{
        font-family: var(--font-heading);
        font-size: 1.5rem;
        color: var(--color-primary);
        display: flex;
        align-items: center;
    }
    .logo i {
        margin-right: 8px;
    }
    .btn {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .btn.primary {
        background-color: var(--color-primary);
        color: var(--color-light);
    }
    .btn.primary:hover {
        background-color: #9b47e5;
    }
    .container {
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
    }
    .page-title {
        font-family: var(--font-heading);
        color: var(--color-secondary);
        text-align: center;
        margin-bottom: 40px;
    }

    /* ------------------------------------- */
    /* II. Cart Specific Styles */
    /* ------------------------------------- */
    .cart-grid {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 30px;
    }
    .cart-items {
        background-color: var(--color-accent);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .cart-summary {
        background-color: #1a1a36;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        height: fit-content;
        position: sticky;
        top: 20px;
    }
    .cart-summary h2 {
        font-family: var(--font-heading);
        color: var(--color-primary);
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
        margin-top: 0;
        margin-bottom: 20px;
    }
    .cart-summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    .cart-total {
        font-size: 1.8rem;
        font-weight: 700;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed #666;
        color: var(--color-success);
    }
    .checkout-btn {
        width: 100%;
        margin-top: 20px;
        font-size: 1.1rem;
        padding: 15px;
    }

    /* Cart Item List */
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #444;
    }
    .item-details {
        flex-grow: 1;
    }
    .item-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--color-secondary);
    }
    .item-price {
        font-size: 0.9em;
        color: var(--color-light);
    }
    .item-controls {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .quantity-controls button {
        background-color: var(--color-dark);
        color: var(--color-light);
        border: 1px solid var(--color-primary);
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: 700;
        transition: background-color 0.2s;
    }
    .quantity-controls button:hover {
        background-color: var(--color-primary);
    }
    .quantity-display {
        width: 30px;
        text-align: center;
        font-weight: 600;
    }
    .remove-btn {
        background: none;
        border: none;
        color: var(--color-error);
        cursor: pointer;
    }
    .remove-btn i {
        transition: transform 0.2s;
    }
    .remove-btn:hover i {
        transform: scale(1.1);
    }
    .empty-cart-message {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: var(--color-primary);
    }

    @media screen and (max-width: 768px) {
        .cart-grid {
            grid-template-columns: 1fr;
        }
        .cart-summary {
            position: static;
        }
    }
  </style>
</head>
<body>

  <header class="header">
    <a href="index.html" class="logo">
        <i data-lucide="moon" style="width: 24px; height: 24px;"></i>
        LUNAR VEIL CAFE ☕
    </a>
    <nav class="nav">
        <a href="index.html">Home</a>
        <a href="menu.html">Menu</a>
        <a href="transactions.html">Wallet</a>
        <a href="tracking.html">Tracking</a> <a href="cart.html">Cart (<span id="cart-count">0</span>)</a>
    </nav>
    <div style="color: var(--color-light); font-weight: 600;">
        <span id="welcome-user">Welcome, Guest!</span> | 
        <span id="wallet-balance-header">Balance: $0.00</span> |
        <button id="logout-btn" class="btn primary" style="padding: 5px 10px;">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i> Logout
        </button>
    </div>
  </header>

  <main>
    <div class="container">
        <h1 class="page-title">Your Cart</h1>
        
        <div class="cart-grid">
            
            <div id="cartItemsContainer" class="cart-items">
                <p class="empty-cart-message">Your cart is currently empty. <a href="menu.html">Explore our menu!</a></p>
            </div>

            <div class="cart-summary">
                <h2>Order Summary</h2>
                
                <div class="cart-summary-row">
                    <span>Subtotal:</span>
                    <span id="summary-subtotal">$0.00</span>
                </div>
                <div class="cart-summary-row">
                    <span>Tax (5%):</span>
                    <span id="summary-tax">$0.00</span>
                </div>
                <div class="cart-summary-row">
                    <span>Delivery Fee:</span>
                    <span id="summary-delivery-fee">Calculated at Checkout</span>
                </div>
                
                <div class="cart-summary-row cart-total">
                    <span>Estimated Total:</span>
                    <span id="summary-grand-total">$0.00</span>
                </div>

                <button id="checkout-btn" class="btn primary checkout-btn" disabled>
                    <i data-lucide="wallet" style="width: 20px; height: 20px;"></i> Proceed to Checkout
                </button>
                <button id="clear-cart-btn" class="btn primary checkout-btn" style="background-color: var(--color-error);">
                    <i data-lucide="trash-2" style="width: 20px; height: 20px;"></i> Clear Cart
                </button>
            </div>
            
        </div>
    </div>
  </main>

<script>
    let cart = JSON.parse(localStorage.getItem('cafeCart') || '[]');
    let isLoggedIn = false;
    const TAX_RATE = 0.05;

    // =============================================
    // I. AUTHENTICATION & UI HELPERS
    // =============================================
    
    function renderCartCount() {
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cart-count').textContent = totalItems;
        
        // Enable/Disable checkout button
        document.getElementById('checkout-btn').disabled = cart.length === 0;
        document.getElementById('clear-cart-btn').disabled = cart.length === 0;
    }

    async function loadWalletBalance() {
        if (!isLoggedIn) return;
        try {
            const response = await fetch('wallet.php', {
                method: 'POST', body: JSON.stringify({ action: 'get_balance' }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.success) {
                const balance = parseFloat(data.balance).toFixed(2);
                document.getElementById('wallet-balance-header').textContent = `Balance: $${balance}`;
            }
        } catch (error) { console.error('Error fetching balance:', error); }
    }

    async function checkLoginStatus() {
        const welcomeUserSpan = document.getElementById('welcome-user');
        try {
            const response = await fetch('auth.php', {
                method: 'POST', body: JSON.stringify({ action: 'status' }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (!data.isLoggedIn) {
                window.location.href = 'login.html';
            } else {
                isLoggedIn = true;
                welcomeUserSpan.textContent = `Welcome, ${data.username}!`;
                loadWalletBalance();
                renderCart();
                renderCartCount();
                lucide.createIcons();
            }
        } catch (error) {
            console.error('Error checking login status:', error);
            welcomeUserSpan.textContent = 'Connection Error';
        }
    }
    
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await fetch('auth.php', { method: 'POST', body: JSON.stringify({ action: 'logout' }), headers: { 'Content-Type': 'application/json' } });
        window.location.href = 'login.html';
    });


    // =============================================
    // II. CART & SUMMARY LOGIC
    // =============================================
    
    /** Saves the current cart state to localStorage */
    function saveCart() {
        localStorage.setItem('cafeCart', JSON.stringify(cart));
    }

    /** Calculates subtotal, tax, and grand total. */
    function calculateSummary() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = subtotal * TAX_RATE;
        const grandTotal = subtotal + tax; // Delivery fee is calculated on checkout page
        
        document.getElementById('summary-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('summary-tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('summary-grand-total').textContent = `$${grandTotal.toFixed(2)}`;

        return { subtotal, tax, grandTotal };
    }

    /** Renders the cart items and summary */
    function renderCart() {
        const container = document.getElementById('cartItemsContainer');
        
        if (cart.length === 0) {
            container.innerHTML = '<p class="empty-cart-message">Your cart is currently empty. <a href="menu.html">Explore our menu!</a></p>';
        } else {
            container.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">@ $${item.price.toFixed(2)}</div>
                    </div>
                    <div class="item-controls">
                        <div class="quantity-controls">
                            <button onclick="updateQuantity(${index}, -1)">-</button>
                            <span class="quantity-display">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                        <div style="font-size: 1.1em; font-weight: 600;">$${(item.price * item.quantity).toFixed(2)}</div>
                        <button class="remove-btn" onclick="removeItem(${index})">
                            <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons(); // Re-render Lucide icons
        }
        
        calculateSummary();
        renderCartCount();
    }

    /** Updates the quantity of a cart item */
    function updateQuantity(index, delta) {
        if (index < 0 || index >= cart.length) return;

        const newQuantity = cart[index].quantity + delta;

        if (newQuantity <= 0) {
            removeItem(index);
        } else {
            cart[index].quantity = newQuantity;
            saveCart();
            renderCart();
        }
    }

    /** Removes an item from the cart */
    function removeItem(index) {
        if (index < 0 || index >= cart.length) return;
        
        if (confirm(`Are you sure you want to remove ${cart[index].name} from your cart?`)) {
            cart.splice(index, 1);
            saveCart();
            renderCart();
        }
    }

    /** Clears the entire cart */
    document.getElementById('clear-cart-btn').addEventListener('click', () => {
        if (cart.length > 0 && confirm("Are you sure you want to clear your entire cart?")) {
            cart = [];
            saveCart();
            renderCart();
        }
    });

    /** Handles the checkout process - FIXED TO REDIRECT */
    document.getElementById('checkout-btn').addEventListener('click', () => {
        if (cart.length === 0) {
            alert("Your cart is empty. Please add items before checking out.");
            return;
        }

        // --- FIX: Redirects to the dedicated checkout page ---
        window.location.href = 'checkout.html';
    });


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', checkLoginStatus);
</script>

</body>
</html>